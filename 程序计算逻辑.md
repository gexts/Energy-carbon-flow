# 程序计算逻辑

## 总述

​	模型以小时为步长，沿“电网潮流与碳流—气网稳态与碳流—能量枢纽耦合—热网水力/热力稳态与碳流—储热”的顺序在统一数据口径下进行耦合计算：每小时先用外部Excel数据覆盖电负荷、热负荷与可选的 EH 输入，再解交流潮流得到母线电压与支路功率，并在此基础上构造线性碳势场以获得节点碳强度与支路/负荷碳流率；随后在气网中用节点—管段关联矩阵的最小二乘解恢复管段体积流率，并用固定热值系数与气体碳强度得到气侧碳流；再由 EH 将电、气两输入通过能量耦合矩阵与碳耦合矩阵映射为多端口输出，并把热端口的功率与碳强度回写为热网“热源”；热网采用带符号质量流率的一阶指数传热近似，迭代求解水力后在给定流量下计算管段进/出口温度与系统出力，并以热源 GCI 统一计算热侧碳流；若配置长周期储热，采用“优先直供—富余入池—缺口出池”的并联策略在 EH 与热网之间闭合能量与碳收支，最后把各系统量与关键 KPI 逐时写入宽表与分系统结果表。全流程统一单位：功率/能量（MW/MWh）、碳强度（tCO₂/MWh）、碳流率（tCO₂/h）、温度（°C）、质量流量（kg/s，热侧）与体积流量（km³/h，气侧）。

## 能量枢纽耦合与热源写回

​	设输入功率向量 $\boldsymbol{u}=[E,\;G]^\top$（电、气）与输入碳强度 $\boldsymbol{\pi}_{\text{in}}=[\mathrm{PCI}_e,\;\mathrm{PCI}_g]^\top$。EH 的多端口输出功率 $\boldsymbol{y}$ 由线性耦合矩阵 $C$ 给出：$\boldsymbol{y}=C\,\boldsymbol{u}$；各端口碳强度由矩阵 $D$ 给出：$\boldsymbol{\pi}_{\text{out}}=D\,\boldsymbol{\pi}_{\text{in}}$，从而端口碳流率为 $\mathrm{CEFR}=\boldsymbol{\pi}_{\text{out}}\odot\boldsymbol{y}$。其中 $\mathrm{PCI}_e$ 取自电网该母线的 NCI，$\mathrm{PCI}_g$ 为约定的气侧碳强度常数；EH 的热端口（如 `heat_o1`）将 $(Q_{\text{EH}},\mathrm{PCI}_{\text{EH}})$ 回写为热网的热源功率与热源碳强度，从而保证电/气→热的能–碳口径一致。

## 电力系统与电储能

​	电侧先执行稳健 AC 潮流得到功率分布，并构造线性碳势场：以支路受端功率矩阵 $PB$、机组注入矩阵 $PG$ 与节点受入对角阵 $PN=\mathrm{diag}(\mathbf{1}^\top[PB;PG])$ 表示潮流分配关系，令机组碳强度向量为 $EG$，则节点碳势由线性方程 $(PN-PB^\top)EN=PG^\top EG$ 解得，进而支路碳强度 $BCI_\ell=EN_{\mathrm{from}(\ell)}$，并可计算支路/负荷/损耗的碳流率。电储能采用“水箱”差分模型，时间步长 $\Delta t$（h），能量与碳库存递推为
$$
\begin{aligned}
e_{t+1}&=\kappa\,e_t+\Delta t\!\left(\eta_{\mathrm{ch}}P_{\mathrm{ch},t}-\tfrac{1}{\eta_{\mathrm{dc}}}P_{\mathrm{dc},t}\right),\quad
w^{\mathrm{es}}_t=\frac{E_t}{\max(e_t,\varepsilon)},\\
E_{t+1}&=\kappa\,E_t+\Delta t\!\left(w_{\text{bus},t}\eta_{\mathrm{ch}}P_{\mathrm{ch},t}-\tfrac{w^{\mathrm{es}}_t}{\eta_{\mathrm{dc}}}P_{\mathrm{dc},t}\right),
\end{aligned}
$$
其中 $e$ 为储能电量（MWh）、$E$ 为储能内含碳（tCO₂）、$w_{\text{bus},t}$ 为接入母线当期 NCI、$\kappa\in(0,1]$ 为自放电保留系数、$\eta_{\mathrm{ch}},\eta_{\mathrm{dc}}\in(0,1]$ 为效率；充电在潮流中等效为新增负荷 $+P_{\mathrm{ch}}$，放电等效为新增机组 $+P_{\mathrm{dc}}$ 且机组碳强度取 $w^{\mathrm{es}}_t$。当同一母线存在“原机组+储能放电”时，先按出力加权混合得到该母线整体发电碳强度，再进入上式碳势求解以避免口径分裂。

## 气网稳态与碳流

​	气网以质量平衡为约束设节点—管段关联矩阵 $A_g$，在已知节点注入向量 $\mathrm{inj}$ 的条件下求解 $\dot m$ 满足 $A_g\dot m\simeq\mathrm{inj}$ 的最小二乘解 $\dot m=A_g^\dagger\mathrm{inj}$。令体积流率单位为 km³/h，气—电热值换算常数 $B=10.45\ \mathrm{MWh/(km^3)}$，气体碳强度常数 $\mathrm{CI}=0.20\ \mathrm{tCO_2/MWh}$，则节点与管段的碳流率分别为 $\mathrm{CEFR}_{\text{node}}=B\cdot \mathrm{CI}\cdot \mathrm{inj}$ 与 $\mathrm{CEFR}_{\text{pipe}}=B\cdot \mathrm{CI}\cdot \dot m$，并可据此汇总气侧总碳通量与守恒残差用于诊断。

## 热网水力—热力稳态与碳流

​	热网先解水力后解热力：水力部分以节点—支路关联 $A_h$ 与等效阻抗—源项构造线性系统，采用松弛迭代得到带符号质量流率 $m$；热力部分在给定 $m$ 下采用一阶指数传热近似，设水的比热容为 $c$、管段长度为 $L$、等效热阻为 $R_h(m)$，定义指数 $K=\exp(-c\,m\,R_h\,L)$，并按拓扑对并、串结构进行归一，得到进/出口温度 $(T_{\text{in}},T_{\text{out}})$ 的线性方程组；段功率 $Q_{\text{pipe}}=c\,m\,(T_{\text{in}}-T_{\text{out}})/10^6$ 与系统总出力 $Q_{\text{total}}=\sum Q_{\text{pipe}}$，热侧碳流率以热源 GCI 计：$\mathrm{CEFR}_{\text{pipe}}=\mathrm{GCI}_{\text{heat}}\cdot Q_{\text{pipe}}$、$\mathrm{CEFR}_{\text{total}}=\mathrm{GCI}_{\text{heat}}\cdot Q_{\text{total}}$。EH 的热端口会在每小时起始把 $(Q_{\text{EH}},\mathrm{PCI}_{\text{EH}})$ 写入热源，使热侧口径与电/气侧保持一致。

## 坑式长周期储热的**能量模型**与碳状态

​	储热池几何按截头体分层离散，第 $j$ 层体积 $V_j$、侧壁面积 $A_{\text{side},j}$、顶部/底部面积 $A_{\text{top}},A_{\text{bot}}$ 均由解析几何得到，层热容 $C_j=\rho_w c_{p,w}V_j$。以参考温度 $T_{\text{ref}}$ 定义池内总可用热量：
$$
e=\frac{1}{3.6\times 10^9}\sum_{j=1}^{n} C_j\,(T_j-T_{\text{ref}})\quad[\mathrm{MWh}],
$$
并以显式欧拉在内部细步长 $dt_{\text{int}}$ 下推进温度场：
$$
\frac{\mathrm{d}T_j}{\mathrm{d}t}
=\frac{1}{C_j}\!\left[K_{j-1}(T_{j-1}\!-\!T_j)+K_j(T_{j+1}\!-\!T_j)+K_{\text{side},j}(T_{\text{side}}\!-\!T_j)\right]+\alpha_j\,(T^{\text{in}}_j-T_j),
$$
​	其中垂向导热 $K_j=\lambda_w A^{\text{eq}}_j/\Delta z$，顶部/底部换热 $K_{\text{top}}=U_{\text{top}}A_{\text{top}},\ K_{\text{bot}}=U_{\text{bot}}A_{\text{bot}}$，侧壁换热 $K_{\text{side},j}=U_{\text{side}}A_{\text{side},j}$；对流项采用“自上而下”近似，$\alpha_j=(\dot m\,c_{p,w})/C_j$、$T^{\text{in}}_1=T_{\text{inlet}}$、$T^{\text{in}}_j=T_{j-1}\ (j>1)$。在一个外层小时步内，充热能量估计为 $E_{\text{in}}\approx \dot m\,c_{p,w}\max(0,T_{\text{inlet}}-T_{\text{top}}^{\text{before}})\,\Delta t$，若给定放热指令 $Q_{\text{out}}$ 则从上层起按层能量余额抽取 $E_{\text{out}}=Q_{\text{out}}\Delta t$ 并回代出口温度；能量守恒写为
$$
Q_{\text{loss}}=e_{\text{after}}-e_{\text{before}}-E_{\text{in}}+E_{\text{out}},
$$
其中 $Q_{\text{loss}}\le 0$ 表示经导热与边界散热造成的损失。碳状态采用与电储能一致的“混合碳强度”跟踪：记储热碳库存 $E^{\text{th}}$、混合碳强度 $w^{\text{es}}=E^{\text{th}}/e$，则
$$
E^{\text{th}}_{\text{after}}
=E^{\text{th}}_{\text{before}}
+w_{\text{in}}E_{\text{in}}
+w^{\text{es}}Q_{\text{loss}}
-w^{\text{es}}_{\text{before}}E_{\text{out}},
$$
​	并以新温度场重算 $e$ 与 $w^{\text{es}}$；放热端口的碳强度 $w_{\text{out}}$ 取“放热前”的混合值以保证可追溯性，首次充热时可设定初始 $w_{\text{es},0}$ 以继承来源碳势。

## 并联供热策略与热源 GCI 合成

​	每小时在热负荷 $D$ 与 EH 热端能力 $Q_{\text{EH}}$ 已知的情形下，采用“优先直供—富余入池—缺口出池”策略闭合能量与碳：$Q_{\text{dir}}=\min(Q_{\text{EH}},D)$，$Q_{\text{ch}}=\max(Q_{\text{EH}}-Q_{\text{dir}},0)$（反解所需 $\dot m$ 与 $T_{\text{inlet}}$），$Q_{\text{out}}^{\text{set}}=\max(D-Q_{\text{dir}},0)$；储热模块返回的实际出池功率 $Q_{\text{pit}}$ 及其碳强度 $w_{\text{out}}$ 与 EH 直供共同构成当期热源，合成热源碳强度为
$$
\mathrm{GCI}_{\text{mix}}=\frac{Q_{\text{dir}}\,\mathrm{PCI}_{\text{EH}}+Q_{\text{pit}}\,w_{\text{out}}}{Q_{\text{dir}}+Q_{\text{pit}}}.
$$
该 $\mathrm{GCI}_{\text{mix}}$ 回写至热网热源用于本小时热侧 CEFR 的统一计量，并直接影响后续小时的储热能–碳状态演化。

## 输出口径

​	每小时结束后统一导出电侧的 NCI/BCI 与支路/负荷碳流率、气侧管段碳流率、热侧各管段温度/功率与系统总碳流率，以及 EH 端口功率/碳强度/碳流率；逐时序同时记录储热池的 $e$、$E^{\text{th}}$、$w^{\text{es}}$、$Q_{\text{ch}}$、$Q_{\text{pit}}$、$\mathrm{GCI}_{\text{mix}}$ 等轨迹到“宽表”（列 H00..H23），确保“MW/MWh、tCO₂/h、tCO₂/MWh、°C、kg/s、km³/h”等单位在各子系统与耦合界面完全一致。